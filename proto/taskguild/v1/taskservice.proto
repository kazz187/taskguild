syntax = "proto3";

package taskguild.v1;

import "google/protobuf/timestamp.proto";

option go_package = "github.com/kazz187/taskguild/proto/gen/go/taskguild/v1;taskguildv1";

// TaskService handles task management operations
service TaskService {
  // Create a new task
  rpc CreateTask(CreateTaskRequest) returns (CreateTaskResponse);

  // List all tasks
  rpc ListTasks(ListTasksRequest) returns (ListTasksResponse);

  // Get task details
  rpc GetTask(GetTaskRequest) returns (GetTaskResponse);

  // Update task metadata (description, metadata fields)
  rpc UpdateTask(UpdateTaskRequest) returns (UpdateTaskResponse);

  // Close a task
  rpc CloseTask(CloseTaskRequest) returns (CloseTaskResponse);

  // Try to atomically acquire a process using compare-and-swap semantics
  rpc TryAcquireProcess(TryAcquireProcessRequest) returns (TryAcquireProcessResponse);

  // Complete a process
  rpc CompleteProcess(CompleteProcessRequest) returns (CompleteProcessResponse);

  // Reject a process and cascade-reset dependencies
  rpc RejectProcess(RejectProcessRequest) returns (RejectProcessResponse);
}

// ProcessStatus represents the status of a process
enum ProcessStatus {
  PROCESS_STATUS_UNSPECIFIED = 0;
  PROCESS_STATUS_PENDING = 1;
  PROCESS_STATUS_IN_PROGRESS = 2;
  PROCESS_STATUS_COMPLETED = 3;
  PROCESS_STATUS_REJECTED = 4;
}

// ProcessState represents the state of a process within a task
message ProcessState {
  ProcessStatus status = 1;
  string assigned_to = 2;
  google.protobuf.Timestamp started_at = 3;
  google.protobuf.Timestamp completed_at = 4;
}

// Task represents a task in the system
message Task {
  string id = 1;
  string title = 2;
  string description = 3;
  TaskStatus status = 4;  // Overall status derived from processes
  string type = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
  map<string, string> metadata = 8;
  map<string, ProcessState> processes = 9;  // Process states (implement, review, qa)
}

// TaskStatus represents the overall status of a task (derived from process states)
enum TaskStatus {
  TASK_STATUS_UNSPECIFIED = 0;
  TASK_STATUS_PENDING = 1;      // All processes pending
  TASK_STATUS_IN_PROGRESS = 2;  // At least one process in progress
  TASK_STATUS_COMPLETED = 3;    // All processes completed
  TASK_STATUS_REJECTED = 4;     // At least one process rejected
  TASK_STATUS_CLOSED = 5;       // Task closed
}

// CreateTaskRequest represents a request to create a new task
message CreateTaskRequest {
  string title = 1;
  string description = 2;
  string type = 3;
  map<string, string> metadata = 4;
}

// CreateTaskResponse represents the response from creating a task
message CreateTaskResponse {
  Task task = 1;
}

// ListTasksRequest represents a request to list tasks
message ListTasksRequest {
  string status_filter = 1;
  string type_filter = 2;
  int32 limit = 3;
  int32 offset = 4;
}

// ListTasksResponse represents the response from listing tasks
message ListTasksResponse {
  repeated Task tasks = 1;
  int32 total = 2;
}

// GetTaskRequest represents a request to get a specific task
message GetTaskRequest {
  string id = 1;
}

// GetTaskResponse represents the response from getting a task
message GetTaskResponse {
  Task task = 1;
}

// UpdateTaskRequest represents a request to update a task (metadata only)
message UpdateTaskRequest {
  string id = 1;
  string description = 2;
  map<string, string> metadata = 3;
}

// UpdateTaskResponse represents the response from updating a task
message UpdateTaskResponse {
  Task task = 1;
}

// CloseTaskRequest represents a request to close a task
message CloseTaskRequest {
  string id = 1;
  string reason = 2;
}

// CloseTaskResponse represents the response from closing a task
message CloseTaskResponse {
  Task task = 1;
}

// TryAcquireProcessRequest represents a request to atomically acquire a process
message TryAcquireProcessRequest {
  string task_id = 1;
  string process_name = 2;  // e.g., "implement", "review", "qa"
  string agent_id = 3;
}

// TryAcquireProcessResponse represents the response from trying to acquire a process
message TryAcquireProcessResponse {
  Task task = 1;
  bool success = 2;
  string error_message = 3;
}

// CompleteProcessRequest represents a request to complete a process
message CompleteProcessRequest {
  string task_id = 1;
  string process_name = 2;
  string agent_id = 3;
}

// CompleteProcessResponse represents the response from completing a process
message CompleteProcessResponse {
  Task task = 1;
  bool success = 2;
  string error_message = 3;
}

// RejectProcessRequest represents a request to reject a process
message RejectProcessRequest {
  string task_id = 1;
  string process_name = 2;
  string agent_id = 3;
  string reason = 4;
}

// RejectProcessResponse represents the response from rejecting a process
message RejectProcessResponse {
  Task task = 1;
  bool success = 2;
  string error_message = 3;
  repeated string reset_processes = 4;  // Processes that were reset due to cascade
}
