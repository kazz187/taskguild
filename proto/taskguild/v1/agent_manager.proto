syntax = "proto3";

package taskguild.v1;

import "google/protobuf/timestamp.proto";
import "taskguild/v1/agent.proto";
import "taskguild/v1/interaction.proto";

// AgentManagerService is the bidirectional communication channel between
// the backend and agent-manager instances.
service AgentManagerService {
  // Subscribe opens a server-stream for receiving commands from the backend.
  rpc Subscribe(AgentManagerSubscribeRequest) returns (stream AgentCommand);
  // ClaimTask allows an agent-manager to claim an available task.
  rpc ClaimTask(ClaimTaskRequest) returns (ClaimTaskResponse);
  // ReportTaskResult reports the outcome of a task execution.
  rpc ReportTaskResult(ReportTaskResultRequest) returns (ReportTaskResultResponse);
  // ReportAgentStatus reports the current status of an agent.
  rpc ReportAgentStatus(ReportAgentStatusRequest) returns (ReportAgentStatusResponse);
  // Heartbeat sends periodic health signals from the agent-manager.
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  // CreateInteraction creates a new interaction request from an agent.
  rpc CreateInteraction(CreateInteractionRequest) returns (CreateInteractionResponse);
  // GetInteractionResponse polls for a user's response to an interaction.
  rpc GetInteractionResponse(GetInteractionResponseRequest) returns (GetInteractionResponseResponse);
  // SyncAgents returns all agent definitions for a project so the agent can
  // write them as .claude/agents/*.md files locally.
  rpc SyncAgents(SyncAgentsRequest) returns (SyncAgentsResponse);
}

// --- Subscribe stream ---

message AgentManagerSubscribeRequest {
  string agent_manager_id = 1;
  string project_name = 2;
  int32 max_concurrent_tasks = 3;
}

message AgentCommand {
  oneof command {
    TaskAvailableCommand task_available = 1;
    AssignTaskCommand assign_task = 2;
    CancelTaskCommand cancel_task = 3;
    InteractionResponseCommand interaction_response = 4;
    SyncAgentsCommand sync_agents = 5;
  }
}

// --- Commands ---

message TaskAvailableCommand {
  string task_id = 1;
  string title = 2;
  string agent_config_id = 3;
  map<string, string> metadata = 4;
}

message AssignTaskCommand {
  string task_id = 1;
  string agent_config_id = 2;
  string instructions = 3;
  string worktree_branch = 4;
  map<string, string> metadata = 5;
}

message CancelTaskCommand {
  string task_id = 1;
  string reason = 2;
}

message InteractionResponseCommand {
  string interaction_id = 1;
  string response = 2;
}

// SyncAgentsCommand tells the agent to re-sync its local .claude/agents/*.md files.
message SyncAgentsCommand {}

// --- Task lifecycle ---

message ClaimTaskRequest {
  string task_id = 1;
  string agent_manager_id = 2;
}
message ClaimTaskResponse {
  bool success = 1;
  string agent_config_id = 2;
  string instructions = 3;
  map<string, string> metadata = 4;
}

enum TaskResultStatus {
  TASK_RESULT_STATUS_UNSPECIFIED = 0;
  TASK_RESULT_STATUS_COMPLETED = 1;
  TASK_RESULT_STATUS_FAILED = 2;
}

message ReportTaskResultRequest {
  string task_id = 1;
  TaskResultStatus status = 2;
  string summary = 3;
  string error_message = 4;
}
message ReportTaskResultResponse {}

// --- Agent status ---

enum AgentStatus {
  AGENT_STATUS_UNSPECIFIED = 0;
  AGENT_STATUS_IDLE = 1;
  AGENT_STATUS_RUNNING = 2;
  AGENT_STATUS_WAITING = 3;
  AGENT_STATUS_ERROR = 4;
}

message ReportAgentStatusRequest {
  string agent_manager_id = 1;
  string task_id = 2;
  AgentStatus status = 3;
  string message = 4;
}
message ReportAgentStatusResponse {}

// --- Heartbeat ---

message HeartbeatRequest {
  string agent_manager_id = 1;
  int32 active_tasks = 2;
  google.protobuf.Timestamp timestamp = 3;
}
message HeartbeatResponse {}

// --- Interactions ---

message CreateInteractionRequest {
  string task_id = 1;
  string agent_id = 2;
  InteractionType type = 3;
  string title = 4;
  string description = 5;
  repeated InteractionOption options = 6;
}
message CreateInteractionResponse {
  Interaction interaction = 1;
}

message GetInteractionResponseRequest {
  string interaction_id = 1;
}
message GetInteractionResponseResponse {
  Interaction interaction = 1;
}

// --- Agent sync ---

message SyncAgentsRequest {
  string project_name = 1;
}
message SyncAgentsResponse {
  repeated AgentDefinition agents = 1;
}
